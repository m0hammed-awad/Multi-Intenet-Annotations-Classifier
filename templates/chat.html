{% extends "base.html" %}

{% block title %}Chat - ConvoSense{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i data-feather="message-circle" class="me-2"></i>
                        Customer Support Chat
                    </h5>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="clearChat()">
                            <i data-feather="trash-2" class="me-1"></i>
                            Clear
                        </button>
                        <span class="badge bg-success" id="status-indicator">Connected</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Chat Messages Container -->
                    <div id="chat-container" class="chat-container p-3" style="height: 500px; overflow-y: auto;">
                        <div class="message assistant">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <i data-feather="headphones" style="width: 20px; height: 20px;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">Support Agent</h6>
                                    <p class="mb-0">Hello! I'm here to help you with any questions or issues you may have. How can I assist you today?</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="border-top p-3">
                        <form id="chat-form" class="d-flex">
                            <div class="flex-grow-1 me-2">
                                <input type="text" id="message-input" class="form-control" 
                                       placeholder="Type your message here..." required>
                            </div>
                            <button type="submit" class="btn btn-primary" id="send-button">
                                <i data-feather="send" class="me-1"></i>
                                Send
                            </button>
                        </form>
                        
                        <!-- Typing Indicator -->
                        <div id="typing-indicator" class="text-muted small mt-2" style="display: none;">
                            <i data-feather="more-horizontal" class="me-1"></i>
                            AI is typing...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Intent Analysis Modal -->
<div class="modal fade" id="intentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i data-feather="target" class="me-2"></i>
                    Intent Analysis
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="intent-details">
                    <!-- Intent details will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
class ChatInterface {
    constructor() {
        this.chatContainer = document.getElementById('chat-container');
        this.messageInput = document.getElementById('message-input');
        this.chatForm = document.getElementById('chat-form');
        this.sendButton = document.getElementById('send-button');
        this.typingIndicator = document.getElementById('typing-indicator');
        this.statusIndicator = document.getElementById('status-indicator');
        
        this.setupEventListeners();
        this.loadConversationHistory();
        
        // Focus on input
        this.messageInput.focus();
    }
    
    setupEventListeners() {
        this.chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.sendMessage();
        });
        
        // Auto-resize input on typing
        this.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
    }
    
    async loadConversationHistory() {
        try {
            const response = await fetch('/api/conversation');
            const data = await response.json();
            
            if (data.messages && data.messages.length > 0) {
                // Clear welcome message and show conversation history
                this.chatContainer.innerHTML = '';
                data.messages.forEach(message => {
                    this.displayMessage(message.content, message.role, message.intents);
                });
            }
        } catch (error) {
            console.error('Error loading conversation history:', error);
        }
    }
    
    async sendMessage() {
        const message = this.messageInput.value.trim();
        if (!message) return;
        
        // Display user message
        this.displayMessage(message, 'user');
        this.messageInput.value = '';
        
        // Show typing indicator
        this.showTypingIndicator();
        this.setButtonState(false);
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Display AI response with intents
                this.displayMessage(data.response, 'assistant', data.intents);
            } else {
                this.displayMessage(
                    data.error || 'Sorry, I encountered an error. Please try again.', 
                    'assistant'
                );
            }
        } catch (error) {
            console.error('Error sending message:', error);
            this.displayMessage(
                'Sorry, I\'m having trouble connecting. Please check your internet connection and try again.', 
                'assistant'
            );
        } finally {
            this.hideTypingIndicator();
            this.setButtonState(true);
            this.messageInput.focus();
        }
    }
    
    displayMessage(content, role, intents = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const isUser = role === 'user';
        const icon = isUser ? 'user' : 'headphones';
        const name = isUser ? 'You' : 'Support Agent';
        const bgColor = isUser ? 'bg-secondary' : 'bg-primary';
        
        let intentBadges = '';
        if (intents && intents.length > 0) {
            intentBadges = '<div class="mt-2">';
            intents.forEach(intent => {
                const confidenceClass = this.getConfidenceClass(intent.confidence);
                intentBadges += `
                    <span class="intent-badge ${confidenceClass}" 
                          onclick="showIntentDetails('${intent.intent}', ${intent.confidence}, '${intent.reasoning || ''}')"
                          style="cursor: pointer;" 
                          title="Click for details">
                        ${intent.intent} (${(intent.confidence * 100).toFixed(0)}%)
                    </span>
                `;
            });
            intentBadges += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0 me-3">
                    <div class="${bgColor} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <i data-feather="${icon}" style="width: 20px; height: 20px;"></i>
                    </div>
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1">${name}</h6>
                    <p class="mb-0">${content}</p>
                    ${intentBadges}
                </div>
            </div>
        `;
        
        this.chatContainer.appendChild(messageDiv);
        
        // Re-initialize feather icons for new content
        feather.replace();
        
        // Scroll to bottom
        this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
    }
    
    getConfidenceClass(confidence) {
        if (confidence >= 0.7) return 'confidence-high';
        if (confidence >= 0.4) return 'confidence-medium';
        return 'confidence-low';
    }
    
    showTypingIndicator() {
        this.typingIndicator.style.display = 'block';
        feather.replace();
    }
    
    hideTypingIndicator() {
        this.typingIndicator.style.display = 'none';
    }
    
    setButtonState(enabled) {
        this.sendButton.disabled = !enabled;
        this.messageInput.disabled = !enabled;
        
        if (enabled) {
            this.sendButton.innerHTML = '<i data-feather="send" class="me-1"></i> Send';
            this.statusIndicator.textContent = 'Connected';
            this.statusIndicator.className = 'badge bg-success';
        } else {
            this.sendButton.innerHTML = '<i data-feather="loader" class="me-1"></i> Sending...';
            this.statusIndicator.textContent = 'Sending...';
            this.statusIndicator.className = 'badge bg-warning';
        }
        
        feather.replace();
    }
}

// Global functions
function showIntentDetails(intent, confidence, reasoning) {
    const modal = new bootstrap.Modal(document.getElementById('intentModal'));
    const detailsDiv = document.getElementById('intent-details');
    
    detailsDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Intent Category</h6>
                <span class="badge bg-primary fs-6">${intent}</span>
            </div>
            <div class="col-md-6">
                <h6>Confidence Score</h6>
                <span class="badge ${confidence >= 0.7 ? 'bg-success' : confidence >= 0.4 ? 'bg-warning' : 'bg-danger'} fs-6">
                    ${(confidence * 100).toFixed(1)}%
                </span>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-12">
                <h6>Analysis Reasoning</h6>
                <p class="text-muted">${reasoning || 'No detailed reasoning available.'}</p>
            </div>
        </div>
    `;
    
    modal.show();
}

async function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        try {
            const response = await fetch('/api/clear', { method: 'POST' });
            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('Error clearing chat:', error);
        }
    }
}

// Initialize chat interface when page loads
document.addEventListener('DOMContentLoaded', () => {
    new ChatInterface();
});
</script>
{% endblock %}